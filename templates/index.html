<!DOCTYPE html>
<html>
  <head>
    <title>Music Recommender</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1>üéµ Music Recommender System</h1>

      <div class="section">
        <h2>Rate Some Songs</h2>
        <p>Rate songs from 1-5 stars to get personalized recommendations!</p>
        <div id="songs-list"></div>
      </div>

      <div class="section">
        <h2>Recommendation Method</h2>
        <select id="method">
          <option value="collaborative">Collaborative Filtering</option>
          <option value="content">Content-Based</option>
          <option value="hybrid">Hybrid (Both)</option>
        </select>
        <button onclick="getRecommendations()">Get Recommendations</button>
      </div>

      <div class="section">
        <h2>Your Recommendations</h2>
        <div id="recommendations"></div>
      </div>
    </div>

    <script>
      let allSongs = [];
      let userRatings = {};

      // Load songs on page load
      async function loadSongs() {
        try {
          const response = await fetch("/api/songs");
          allSongs = await response.json();
          displaySongs();
        } catch (error) {
          console.error("Error loading songs:", error);
        }
      }

      function displaySongs() {
        const container = document.getElementById("songs-list");
        container.innerHTML = "";

        // Show first 10 songs for rating
        allSongs.slice(0, 10).forEach((song) => {
          const songDiv = document.createElement("div");
          songDiv.className = "song-item";
          songDiv.innerHTML = `
                    <div class="song-info">
                        <strong>${song.title}</strong> by ${song.artist}
                        <br><small>${song.genre} ‚Ä¢ ${song.year}</small>
                    </div>
                    <div class="rating">
                        ${[1, 2, 3, 4, 5]
                          .map(
                            (star) =>
                              `<span class="star" onclick="rateSong(${song.song_id}, ${star})">${star}‚≠ê</span>`
                          )
                          .join("")}
                    </div>
                `;
          container.appendChild(songDiv);
        });
      }

      function rateSong(songId, rating) {
        userRatings[songId] = rating;

        // Update UI to show selected rating
        const songItem = event.target.closest(".song-item");
        const stars = songItem.querySelectorAll(".star");
        stars.forEach((star, index) => {
          star.style.backgroundColor = index < rating ? "#ffd700" : "#f0f0f0";
        });

        console.log("Rated song", songId, "with", rating, "stars");
      }

      async function getRecommendations() {
        if (Object.keys(userRatings).length === 0) {
          alert("Please rate at least one song first!");
          return;
        }

        try {
          const method = document.getElementById("method").value;
          const response = await fetch("/api/recommend", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ratings: userRatings,
              method: method,
            }),
          });

          const recommendations = await response.json();
          displayRecommendations(recommendations);
        } catch (error) {
          console.error("Error getting recommendations:", error);
        }
      }

      function displayRecommendations(recommendations) {
        const container = document.getElementById("recommendations");
        container.innerHTML = "";

        if (recommendations.length === 0) {
          container.innerHTML =
            "<p>No recommendations found. Try rating more songs!</p>";
          return;
        }

        recommendations.forEach((song, index) => {
          const recDiv = document.createElement("div");
          recDiv.className = "recommendation-item";
          recDiv.innerHTML = `
                    <div class="rec-number">#${index + 1}</div>
                    <div class="song-info">
                        <strong>${song.title}</strong> by ${song.artist}
                        <br><small>${song.genre} ‚Ä¢ ${song.year} ‚Ä¢ Popularity: ${
            song.popularity
          }</small>
                    </div>
                `;
          container.appendChild(recDiv);
        });
      }

      // Load songs when page loads
      loadSongs();
    </script>
  </body>
</html>
